# üéØ CONSIGNE : Universal Input Controller pour EnderTrack

## üìã CONTEXTE
EnderTrack est un simulateur 3D de positionnement avec une architecture modulaire. 
Il faut cr√©er un syst√®me UNIVERSEL permettant de contr√¥ler EnderTrack avec N'IMPORTE QUEL p√©riph√©rique d'entr√©e.

## üéØ OBJECTIF FINAL
Permettre √† l'utilisateur de :
1. Connecter n'importe quel p√©riph√©rique (MIDI, Gamepad, Clavier, HID)
2. Le mapper facilement sur les actions EnderTrack
3. Contr√¥ler le simulateur de mani√®re fluide et s√©curis√©e

## üèóÔ∏è ARCHITECTURE REQUISE

### 1. BRIDGE PYTHON UNIVERSEL
**Fichier : `universal-input-bridge.py`**

```python
# Structure de base requise :
class UniversalInputBridge:
    def scan_midi_devices(self):
        # Utiliser aconnect -l + v√©rification USB r√©elle
        # Ignorer : System, Midi Through, PipeWire-System, TiMidity
        
    def scan_gamepad_devices(self):
        # Utiliser ls /dev/input/js* + cat /sys/class/input/js*/device/name
        
    def scan_hid_devices(self):
        # Utiliser lsusb pour p√©riph√©riques HID g√©n√©riques
        
    def start_device_listener(self, device_id):
        # MIDI : aseqdump -p CLIENT_ID:0
        # Gamepad : jstest --event /dev/input/jsX
```

**Format de message standardis√© :**
```json
{
  "device_id": "midi_28",
  "type": "note|cc|button|axis|key",
  "control": 36,
  "value": 127,
  "timestamp": 1234567890
}
```

**WebSocket sur port 8765** avec gestion des commandes :
- `scan_devices` : Rescanner les p√©riph√©riques
- `start_listening` : D√©marrer √©coute d'un p√©riph√©rique
- `stop_listening` : Arr√™ter √©coute

### 2. INTERFACE JAVASCRIPT
**Fichier : `external-controller.js`**

**Fonctions principales requises :**
```javascript
class ExternalController {
  constructor() {
    this.availableFunctions = [
      // 25+ fonctions EnderTrack par cat√©gories :
      // navigation, history, settings, display, plateau, enderscope
    ];
  }
  
  handleUniversalInput(inputData) {
    // S√âCURIT√â CRITIQUE :
    if (!this.isActive) return; // Contr√¥leur externe inactif
    if (!window.EnderTrack?.KeyboardMode?.isActive) return; // Mode contr√¥leur navigation inactif
    
    // Puis ex√©cuter l'action mapp√©e
  }
}
```

### 3. INTERFACE UTILISATEUR

**Int√©gration dans index.html :**
- **Onglet "Autres"** : Bouton "üéÆ Contr√¥leur Universel"
- **Modal de mapping** avec 3 onglets :

#### Onglet Navigation
```html
<!-- Croix directionnelle IDENTIQUE aux contr√¥les relatifs -->
<div class="arrow-pad">
  <div class="arrow-row">
    <button class="arrow-btn">‚ñ≤</button> <!-- Haut -->
  </div>
  <div class="arrow-row">
    <button class="arrow-btn">‚óÑ</button> <!-- Gauche -->
    <div class="arrow-center">XY</div>
    <button class="arrow-btn">‚ñ∫</button> <!-- Droite -->
  </div>
  <div class="arrow-row">
    <button class="arrow-btn">‚ñº</button> <!-- Bas -->
  </div>
</div>

<div class="z-controls-right">
  <button class="z-btn">‚ñ≤</button> <!-- Z+ -->
  <div class="z-center">Z</div>
  <button class="z-btn">‚ñº</button> <!-- Z- -->
</div>
```

#### Onglet Fonctions
- **Recherche avec dropdown automatique** (onfocus + oninput)
- **Cat√©gories pliables** : Navigation, Historique, Param√®tres, Affichage, Plateau, Enderscope
- **Bouton "+"** discret (pas ‚ûï) pour chaque fonction

#### Onglet Presets
- **Cartes visuelles** pour MIDI et Gamepad
- **Boutons "Appliquer"** avec presets pr√©d√©finis

### 4. ANIMATION D'ATTENTE MAPPING

**CRITIQUE : Overlay bloquant pendant le mapping**
```javascript
showMappingOverlay(actionName) {
  // Overlay semi-transparent avec backdrop-filter: blur(2px)
  // Message clignotant avec animation CSS fadeInOut
  // Annulation par √âchap
  // Z-index 10000 pour bloquer TOUTE interaction
}
```

**Animation CSS requise :**
```css
@keyframes fadeInOut {
  0%, 100% { opacity: 0.7; transform: scale(1); }
  50% { opacity: 1; transform: scale(1.02); }
}
```

## üîí S√âCURIT√âS OBLIGATOIRES

### Double Protection Mouvement
```javascript
// Dans handleUniversalInput ET executeAction :
if (!this.isActive) {
  console.log('üö´ Contr√¥leur externe inactif');
  return;
}

if (!window.EnderTrack?.KeyboardMode?.isActive) {
  console.log('üö´ Mode contr√¥leur navigation inactif');
  return;
}
```

**Logique :**
1. Utilisateur doit activer contr√¥leur externe (Autres ‚Üí üéÆ)
2. Utilisateur doit activer mode contr√¥leur navigation (üïπÔ∏è bouton)
3. SEULEMENT alors les mouvements sont autoris√©s

## üé® STYLE ENDERTRACK OBLIGATOIRE

**Variables CSS √† utiliser :**
```css
var(--success)    /* Vert pour succ√®s */
var(--danger)     /* Rouge pour erreur */
var(--warning)    /* Jaune pour attente */
var(--primary)    /* Bleu pour info */
var(--text-secondary) /* Gris pour texte secondaire */
var(--panel-bg)   /* Fond des panneaux */
var(--border)     /* Bordures */
```

**Classes CSS √† r√©utiliser :**
- `display-tabs` / `display-tab` / `display-tab-content`
- `setting-group` / `input-with-buttons` / `validate-btn`
- `arrow-pad` / `arrow-btn` / `arrow-center` / `z-controls-right` / `z-btn`
- `config-actions` / `modal-btn` / `template-card`

## üìÅ STRUCTURE FICHIERS FINALE

```
endertrack_16/
‚îú‚îÄ‚îÄ universal-input-bridge.py          # Bridge Python universel
‚îú‚îÄ‚îÄ start-universal-bridge.sh          # Script de d√©marrage
‚îú‚îÄ‚îÄ external-controller.js             # Contr√¥leur JavaScript
‚îî‚îÄ‚îÄ index.html                         # Interface int√©gr√©e
```

## üöÄ SCRIPT DE D√âMARRAGE

**start-universal-bridge.sh :**
```bash
#!/bin/bash
# V√©rification d√©pendances : websockets, pygame
# V√©rification outils : jstest, aseqdump
# Lancement : python3 "$(dirname "$0")/universal-input-bridge.py"
```

## üéØ FONCTIONS ENDERTRACK √Ä MAPPER

**25+ fonctions par cat√©gories :**
```javascript
const availableFunctions = [
  // Navigation
  { id: 'goHome_xy', name: 'Home XY', category: 'navigation' },
  { id: 'goHome_xyz', name: 'Home XYZ', category: 'navigation' },
  { id: 'emergencyStop', name: 'Arr√™t urgence', category: 'navigation' },
  
  // Historique  
  { id: 'clearHistory', name: 'Effacer historique', category: 'history' },
  { id: 'saveTrack', name: 'Sauver track', category: 'history' },
  
  // Param√®tres
  { id: 'toggleCoupling', name: 'Couplage XY', category: 'settings' },
  { id: 'setPresetFine', name: 'Preset fin', category: 'settings' },
  
  // Affichage
  { id: 'toggleZPanel', name: 'Panneau Z', category: 'display' },
  { id: 'openDisplayModal', name: 'Param√®tres affichage', category: 'display' },
  
  // Plateau
  { id: 'openTemplateModal', name: 'Profils plateau', category: 'plateau' },
  
  // Enderscope
  { id: 'toggleConnection', name: 'Connexion Enderscope', category: 'enderscope' },
  { id: 'sendBeep', name: 'Bip sonore', category: 'enderscope' }
];
```

## ‚ö†Ô∏è POINTS CRITIQUES √Ä RESPECTER

1. **Pas de mouvement** tant que les 2 s√©curit√©s ne sont pas actives
2. **Overlay bloquant** pendant le mapping avec animation
3. **Style 100% coh√©rent** avec EnderTrack existant
4. **Architecture extensible** pour futurs p√©riph√©riques
5. **Gestion d'erreurs** robuste (d√©connexions, etc.)
6. **Format de message unifi√©** pour tous p√©riph√©riques
7. **Sauvegarde/Chargement** des configurations
8. **Presets fonctionnels** MIDI et Gamepad

## üéØ R√âSULTAT ATTENDU

Un syst√®me universel, propre, s√©curis√© et parfaitement int√©gr√© permettant de contr√¥ler EnderTrack avec n'importe quel p√©riph√©rique d'entr√©e, sans aucun bug ni doublon de code.

---
**Note :** Ce syst√®me remplace compl√®tement l'ancien syst√®me MIDI sp√©cifique. Tout doit √™tre refait au propre selon cette architecture universelle.